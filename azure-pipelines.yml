trigger:
- main  # Cambia 'main' por la rama que deseas usar

jobs:
- job: SonarQubeAnalysis
  displayName: "SonarQube Analysis using Docker"
  pool:
    vmImage: 'ubuntu-latest'

  container: 
    image: francotorres01/test-samtel:latest  # Imagen Docker basada en Debian/Ubuntu
    options: '--user root'  

  steps:

  # Paso 2: Configurar el entorno
  - script: |
      echo "Instalando dependencias necesarias..."
      apk update && apk add bash curl openjdk11
    displayName: 'Configurar Entorno'

  # Paso 2.5: Verificar Python y Java
  - script: |
      python3 --version
      java -version
    displayName: 'Verificar instalaci칩n'

  # Paso 3: Preparar SonarQube
  - task: SonarQubePrepare@5
    inputs:
      scannerMode: 'CLI'
      configMode: 'manual'
      cliProjectKey: $(SONARQUBE_PROJECT_KEY)
      cliProjectName: $(SONARQUBE_PROJECT_KEY)
      cliSources: './'  # Analizar solo la carpeta app
      extraProperties: |
        sonar.host.url=$(SONARQUBE_HOST_URL)
        sonar.login=$(SONARQUBE_TOKEN)

  # Paso 4: Compilar y/o analizar el c칩digo
  - script: |
      echo "Analizando el c칩digo fuente..."
      python3 --version
      python3 -m pip install -r requirements.txt || true
    displayName: 'Compilar Proyecto'
    workingDirectory: $(System.DefaultWorkingDirectory)/app

  # Paso 5: Ejecutar el an치lisis de SonarQube
  - task: SonarQubeAnalyze@5

  # Paso 6: Publicar resultados en SonarQube
  - task: SonarQubePublish@5
    inputs:
      pollingTimeoutSec: '300'
