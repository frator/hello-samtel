trigger:
- main # Cambia 'main' por la rama que activar√° el pipeline

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerRegistryServiceConnection: 'DockerHub' # La Service Connection a Docker Hub
  imageName: '$(imageName)' # Reemplaza con el nombre de tu imagen en Docker Hub
  targetImageName: '$(imageName)' # El nombre de la imagen final que quieres usar

stages:
- stage: Build
  displayName: Build and Push Docker Image
  jobs:
  - job: Build
    displayName: Build Job
    steps:
    - checkout: self
      displayName: "Clonar el repositorio"

    # Autenticarse en Docker Hub
    - task: Docker@2
      displayName: "Login en Docker Hub"
      inputs:
        command: login
        containerRegistry: $(dockerRegistryServiceConnection)

    # Traer la imagen base desde Docker Hub
    - script: |
        echo "Descargando imagen base desde Docker Hub..."
        docker pull $(imageName)
      displayName: "Pull de imagen base desde Docker Hub"

    # Construir la nueva imagen usando la imagen base
    - task: Docker@2
      displayName: "Construir imagen Docker"
      inputs:
        command: build
        dockerfile: Dockerfile
        containerRegistry: $(dockerRegistryServiceConnection)
        repository: $(targetImageName)
        tags: |
          $(Build.BuildId)

    # Subir la imagen construida a Docker Hub
    - task: Docker@2
      displayName: "Push de la imagen a Docker Hub"
      inputs:
        command: push
        containerRegistry: $(dockerRegistryServiceConnection)
        repository: $(targetImageName)
        tags: |
          $(Build.BuildId)
